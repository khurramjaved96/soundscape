<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>PersonalScapes</title>

    <!-- update the version number as needed -->
    <script defer src="/__/firebase/10.11.1/firebase-app-compat.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/10.11.1/firebase-auth-compat.js"></script>
    <script defer src="/__/firebase/10.11.1/firebase-database-compat.js"></script>
    <script defer src="/__/firebase/10.11.1/firebase-firestore-compat.js"></script>
    <script defer src="/__/firebase/10.11.1/firebase-functions-compat.js"></script>
    <script defer src="/__/firebase/10.11.1/firebase-messaging-compat.js"></script>
    <script defer src="/__/firebase/10.11.1/firebase-storage-compat.js"></script>
    <script defer src="/__/firebase/10.11.1/firebase-analytics-compat.js"></script>
    <script defer src="/__/firebase/10.11.1/firebase-remote-config-compat.js"></script>
    <script defer src="/__/firebase/10.11.1/firebase-performance-compat.js"></script>

    <link rel="stylesheet" href="https://use.typekit.net/cyl2tsd.css">

    <script src="https://www.gstatic.com/firebasejs/ui/6.1.0/firebase-ui-auth.js"></script>
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.1.0/firebase-ui-auth.css"/>
    <script defer src="/__/firebase/init.js?useEmulator=true"></script>
</head>
<body class="bg-gradient-to-r   from-slate-100 to-slate-500">

<audio id="rain" src="rain.mp3"></audio>
<audio id="fireplace" src="fireplace.mp3"></audio>
<audio id="waves" src="waves.mp3"></audio>
<audio id="thunder" src="thunder.mp3"></audio>
<audio id="kids" src="kids.mp3"></audio>


<div class="container filter drop-shadow-lg mx-auto">

    <div class="grid grid-cols-2">
        <div class="mx-auto my-auto text-slate-100" id="user">User:</div>
        <button class="mx-auto my-auto text-slate-100" id="signout" onclick="firebase.auth().signOut()">Sign out
        </button>
    </div>
    <div class="pt-1 pl-2 pr-8 pb-2">
        <div id='heading'
             class="text-center  tracking-wide text-6xl text-slate-100 mx-auto my-8">
            Compose your soundscape
        </div>
    </div>
    <div id='parentBox'
         class="flex rounded-full  bg-opacity-30 bg-white  relative  lg:w-5/12 md:w-8/12 w-10/12 aspect-square mx-auto">
        <div id="headDiv" class="mx-auto my-auto">

            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                 class="md:w-24 md:h-24 h-12 w-12 fill-slate-500" fill="currentColor" viewBox="0 0 256 256"
                 xml:space="preserve">
                <g><g><g><path  d="M231.7,140.5c0-10.4-5.8-19.2-14-22.8c-0.7-9.2-1.2-17.3-0.9-20.8c0.8-10.1,8.1-52,0.8-62.6c-6.1-8.9-17.2-12.9-20.5-13.9L172.2,10l-7.5,12.6l23.5,12.6c2.8,1.7,14.3,9.1,17.8,15c1.7,2.9,2.6,8.1,3.2,13.1c-2.4-4.1-5.5-8.5-9.4-12.9C187.9,37,166.4,21.2,130,21.2c-0.8,0-1.7,0-2.6,0c-31.4,0.6-55.7,10-72.3,28c-12,13-17.7,28.6-19,38.8c-1.3,7.7-1.3,18.8-0.4,30.9c-6.8,4.2-11.4,12.2-11.4,21.5c0,10.9,6.3,20,15,23.4c7.8,46.7,44.3,82.1,88.1,82.1c21.2,0,40.8-8.4,56.1-22.3c-3.3,7.1-5.6,12.3-5.7,13.3c-0.3,3.6,9,10.6,10.7,8.7c1.6-1.9,26-61.4,26.8-68.2c0.4-3.6,0.6-9,0.6-13.3C225,161,231.7,151.7,231.7,140.5z M187.3,32.2l-19.4-10.4l5.3-8.8l20.5,8.6L187.3,32.2z M195.1,53.9c8,9,12.4,18.2,14.5,23.5c-0.3,4.4,0.2,16.3,0.7,30.2c-11.1-30.7-35.4-53.7-64.9-60.6c0-0.3,0.1-0.6-0.1-0.8l-2.4-4.4c-0.4-4.7-2.2-8.9-4.9-12.2v-2.5C161.8,28.8,180.9,37.8,195.1,53.9z M125.4,31c5.6,0,10.2,5.7,10.2,12.7c0,0.5-0.1,1.1-0.1,1.6c-2.6-0.2-5.3-0.5-8-0.5c-4.1,0-8.1,0.4-12,1c-0.1-0.7-0.2-1.4-0.2-2.1C115.2,36.7,119.8,31,125.4,31z M42,88.8c0.4-3.2,3.2-20.3,17.5-35.7c13.1-14.2,31.7-22.7,55.2-25.3c-4.2,3.7-7,9.4-7,15.9c0,0.8,0.1,1.5,0.2,2.3l-0.1,0.2c-0.2,0.4-0.2,0.8-0.1,1.2c-31.5,8-56.7,34.7-65.9,69.1c-0.6,0.1-1.1,0.4-1.6,0.6C38.4,99.4,41.3,94.1,42,88.8z M32,140.5c0-5,1.8-9.5,4.6-12.6c0.4,4.1,0.9,8.4,1.5,12.6c-0.1,1.7-0.2,3.3-0.2,5c0,3.1,0.1,6.2,0.4,9.2C34.5,151.6,32,146.4,32,140.5z M127.4,238.6c-32.8,0-61.2-22.1-74.2-53.8c-2.2-7.2-4.8-18.6-7.5-32.7c-0.1-2.2-0.3-4.5-0.3-6.7c0-51.4,36.8-93.2,82.1-93.2c45.3,0,82.1,41.8,82.1,93.2S172.7,238.6,127.4,238.6z M220.6,151.4c-0.5-5.8-1.3-15-2.1-24.4c3.4,3.2,5.7,8,5.7,13.6C224.1,144.7,222.7,148.4,220.6,151.4z"/></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g></g></g>
            </svg>
        </div>
        <div id="soundWaves" class="absolute w-12 h-12 right-0">
            <svg class="md:w-12 md:h-12 h-6 w-6  fill-slate-500" stroke-width="0" fill="currentColor"
                 viewBox="0 0 28 28" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink">
                <path d="M13.3273272,15.7466668 C13.7045496,15.4037373 14.2724576,15.4030196 14.6497962,15.7263586 L14.7399401,15.8139341 L22.4793884,24.3273272 C22.6467265,24.5113992 22.7394483,24.751234 22.7394483,25 C22.7394483,25.5128358 22.3534081,25.9355072 21.8560694,25.9932723 L21.7394483,26 L6.26054465,26 C6.01178566,26 5.77195088,25.9072782 5.58787891,25.7399401 C5.21065649,25.3970106 5.15597791,24.8317405 5.44199817,24.4253848 L5.52061163,24.3273272 L13.2600599,15.8139341 C13.2814025,15.7904572 13.3038503,15.7680094 13.3273272,15.7466668 Z M14,2 C21.1797017,2 27,7.82029825 27,15 C27,18.2793134 25.7857775,21.27503 23.7823937,23.5620884 L23.6905236,23.4372331 L23.5892985,23.318318 L22.7800259,22.427431 C24.4768116,20.4236598 25.5,17.8313191 25.5,15 C25.5,8.64872538 20.3512746,3.5 14,3.5 C7.64872538,3.5 2.5,8.64872538 2.5,15 C2.5,17.8313191 3.52318836,20.4236598 5.21997406,22.427431 L4.41070152,23.318318 C4.344361,23.3912926 4.28314322,23.4773257 4.22702717,23.574518 C2.21632355,21.2802112 1,18.2821494 1,15 C1,7.82029825 6.82029825,2 14,2 Z M14,6 C18.9705627,6 23,10.0294373 23,15 C23,17.0970131 22.2828078,19.0265169 21.0803273,20.5566077 L20.0535231,19.4286002 C20.9629732,18.1875652 21.5,16.6564972 21.5,15 C21.5,10.8578644 18.1421356,7.5 14,7.5 C9.85786438,7.5 6.5,10.8578644 6.5,15 C6.5,16.6564972 7.0370268,18.1875652 7.94647688,19.4286002 L6.91967274,20.5566077 C5.71719218,19.0265169 5,17.0970131 5,15 C5,10.0294373 9.02943725,6 14,6 Z M14,10 C16.7614237,10 19,12.2385763 19,15 C19,15.9195112 18.7517897,16.7810497 18.3187153,17.5212695 L17.2381649,16.3306861 C17.4069266,15.9204527 17.5,15.4710956 17.5,15 C17.5,13.0670034 15.9329966,11.5 14,11.5 C12.0670034,11.5 10.5,13.0670034 10.5,15 C10.5,15.4710956 10.5930734,15.9204527 10.7618351,16.3306861 L9.68128471,17.5212695 C9.2482103,16.7810497 9,15.9195112 9,15 C9,12.2385763 11.2385763,10 14,10 Z"
                      id="ðŸŽ¨-Color">

                </path>
            </svg>


            <p class="text-center text-slate-500">Waves</p>
        </div>
        <div id="soundKids" class="absolute w-12 h-12">
            <svg class="md:w-12 md:h-12 h-6 w-6  fill-slate-500" stroke-width="0" fill="currentColor"
                 viewBox="0 0 28 28" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink">
                <path d="M13.3273272,15.7466668 C13.7045496,15.4037373 14.2724576,15.4030196 14.6497962,15.7263586 L14.7399401,15.8139341 L22.4793884,24.3273272 C22.6467265,24.5113992 22.7394483,24.751234 22.7394483,25 C22.7394483,25.5128358 22.3534081,25.9355072 21.8560694,25.9932723 L21.7394483,26 L6.26054465,26 C6.01178566,26 5.77195088,25.9072782 5.58787891,25.7399401 C5.21065649,25.3970106 5.15597791,24.8317405 5.44199817,24.4253848 L5.52061163,24.3273272 L13.2600599,15.8139341 C13.2814025,15.7904572 13.3038503,15.7680094 13.3273272,15.7466668 Z M14,2 C21.1797017,2 27,7.82029825 27,15 C27,18.2793134 25.7857775,21.27503 23.7823937,23.5620884 L23.6905236,23.4372331 L23.5892985,23.318318 L22.7800259,22.427431 C24.4768116,20.4236598 25.5,17.8313191 25.5,15 C25.5,8.64872538 20.3512746,3.5 14,3.5 C7.64872538,3.5 2.5,8.64872538 2.5,15 C2.5,17.8313191 3.52318836,20.4236598 5.21997406,22.427431 L4.41070152,23.318318 C4.344361,23.3912926 4.28314322,23.4773257 4.22702717,23.574518 C2.21632355,21.2802112 1,18.2821494 1,15 C1,7.82029825 6.82029825,2 14,2 Z M14,6 C18.9705627,6 23,10.0294373 23,15 C23,17.0970131 22.2828078,19.0265169 21.0803273,20.5566077 L20.0535231,19.4286002 C20.9629732,18.1875652 21.5,16.6564972 21.5,15 C21.5,10.8578644 18.1421356,7.5 14,7.5 C9.85786438,7.5 6.5,10.8578644 6.5,15 C6.5,16.6564972 7.0370268,18.1875652 7.94647688,19.4286002 L6.91967274,20.5566077 C5.71719218,19.0265169 5,17.0970131 5,15 C5,10.0294373 9.02943725,6 14,6 Z M14,10 C16.7614237,10 19,12.2385763 19,15 C19,15.9195112 18.7517897,16.7810497 18.3187153,17.5212695 L17.2381649,16.3306861 C17.4069266,15.9204527 17.5,15.4710956 17.5,15 C17.5,13.0670034 15.9329966,11.5 14,11.5 C12.0670034,11.5 10.5,13.0670034 10.5,15 C10.5,15.4710956 10.5930734,15.9204527 10.7618351,16.3306861 L9.68128471,17.5212695 C9.2482103,16.7810497 9,15.9195112 9,15 C9,12.2385763 11.2385763,10 14,10 Z"
                      id="ðŸŽ¨-Color">

                </path>
            </svg>


            <p class="text-center text-slate-500">Kids playing</p>
        </div>
        <div id="soundFirePlace" class="absolute w-12 h-12 bottom-0">
            <svg class="md:w-12 md:h-12 h-6 w-6  fill-slate-500" stroke-width="0" fill="currentColor"
                 viewBox="0 0 28 28" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink">
                <path d="M13.3273272,15.7466668 C13.7045496,15.4037373 14.2724576,15.4030196 14.6497962,15.7263586 L14.7399401,15.8139341 L22.4793884,24.3273272 C22.6467265,24.5113992 22.7394483,24.751234 22.7394483,25 C22.7394483,25.5128358 22.3534081,25.9355072 21.8560694,25.9932723 L21.7394483,26 L6.26054465,26 C6.01178566,26 5.77195088,25.9072782 5.58787891,25.7399401 C5.21065649,25.3970106 5.15597791,24.8317405 5.44199817,24.4253848 L5.52061163,24.3273272 L13.2600599,15.8139341 C13.2814025,15.7904572 13.3038503,15.7680094 13.3273272,15.7466668 Z M14,2 C21.1797017,2 27,7.82029825 27,15 C27,18.2793134 25.7857775,21.27503 23.7823937,23.5620884 L23.6905236,23.4372331 L23.5892985,23.318318 L22.7800259,22.427431 C24.4768116,20.4236598 25.5,17.8313191 25.5,15 C25.5,8.64872538 20.3512746,3.5 14,3.5 C7.64872538,3.5 2.5,8.64872538 2.5,15 C2.5,17.8313191 3.52318836,20.4236598 5.21997406,22.427431 L4.41070152,23.318318 C4.344361,23.3912926 4.28314322,23.4773257 4.22702717,23.574518 C2.21632355,21.2802112 1,18.2821494 1,15 C1,7.82029825 6.82029825,2 14,2 Z M14,6 C18.9705627,6 23,10.0294373 23,15 C23,17.0970131 22.2828078,19.0265169 21.0803273,20.5566077 L20.0535231,19.4286002 C20.9629732,18.1875652 21.5,16.6564972 21.5,15 C21.5,10.8578644 18.1421356,7.5 14,7.5 C9.85786438,7.5 6.5,10.8578644 6.5,15 C6.5,16.6564972 7.0370268,18.1875652 7.94647688,19.4286002 L6.91967274,20.5566077 C5.71719218,19.0265169 5,17.0970131 5,15 C5,10.0294373 9.02943725,6 14,6 Z M14,10 C16.7614237,10 19,12.2385763 19,15 C19,15.9195112 18.7517897,16.7810497 18.3187153,17.5212695 L17.2381649,16.3306861 C17.4069266,15.9204527 17.5,15.4710956 17.5,15 C17.5,13.0670034 15.9329966,11.5 14,11.5 C12.0670034,11.5 10.5,13.0670034 10.5,15 C10.5,15.4710956 10.5930734,15.9204527 10.7618351,16.3306861 L9.68128471,17.5212695 C9.2482103,16.7810497 9,15.9195112 9,15 C9,12.2385763 11.2385763,10 14,10 Z"
                      id="ðŸŽ¨-Color">

                </path>
            </svg>

            <p class="text-center text-slate-500">Fire</p>
        </div>
    </div>

</div>
<div class="rounded-lg  divide-y-2 divide-slate-400 divide-opacity-25 divide-solid relative bg-opacity-30 bg-white m-4 lg:w-4/12 md:w-7/12 w-10/12  mx-auto">

    <div class="grid place-items-center mb-2 pt-2 pb-2 mt-4 w-full  ">
        <canvas id="canvasCtx" height="50" class="w-max"></canvas>
    </div>
    <div class="grid place-items-center pt-2">

        <div class="">
            <button id="playbutton">
                <!--      f              Play-->
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                     stroke="currentColor" class="w-8 h-8  stroke-slate-500 hover:stroke-blue-500">
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="M21 7.5V18M15 7.5V18M3 16.811V8.69c0-.864.933-1.406 1.683-.977l7.108 4.061a1.125 1.125 0 0 1 0 1.954l-7.108 4.061A1.125 1.125 0 0 1 3 16.811Z"/>
                </svg>

            </button>
            <button onclick="generateSoundFromGlobalWeights()">
                <svg fill="none" class="w-8 h-8 stroke-slate-500 hover:stroke-green-600 " id="Capa_1"

                     viewBox="0 0 49.7 49.7" xml:space="preserve">
                <g>
                    <path d="M27,13.85h9v8.964l13.7-9.964L36,2.886v8.964h-9c-7.168,0-13,5.832-13,13c0,6.065-4.935,11-11,11H1c-0.553,0-1,0.447-1,1
                        s0.447,1,1,1h2c7.168,0,13-5.832,13-13C16,18.785,20.935,13.85,27,13.85z M38,6.814l8.3,6.036L38,18.886V6.814z"/>
                    <path d="M1,13.85h2c2.713,0,5.318,0.994,7.336,2.799c0.191,0.171,0.43,0.255,0.667,0.255c0.274,0,0.548-0.112,0.745-0.333
                        c0.368-0.412,0.333-1.044-0.078-1.412C9.285,13.025,6.206,11.85,3,11.85H1c-0.553,0-1,0.447-1,1S0.447,13.85,1,13.85z"/>
                    <path d="M36,35.85h-9c-2.685,0-5.27-0.976-7.278-2.748c-0.411-0.365-1.044-0.327-1.411,0.089c-0.365,0.414-0.326,1.046,0.089,1.411
                        c2.374,2.095,5.429,3.248,8.601,3.248h9v8.964l13.7-9.964L36,26.886V35.85z M38,30.814l8.3,6.036L38,42.886V30.814z"/>
                </g>
                </svg>
            </button>
            <button onclick="learnNow(1)">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                     stroke="currentColor" class="w-8 h-8 stroke-slate-500  hover:stroke-green-600 ">
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="M6.633 10.25c.806 0 1.533-.446 2.031-1.08a9.041 9.041 0 0 1 2.861-2.4c.723-.384 1.35-.956 1.653-1.715a4.498 4.498 0 0 0 .322-1.672V2.75a.75.75 0 0 1 .75-.75 2.25 2.25 0 0 1 2.25 2.25c0 1.152-.26 2.243-.723 3.218-.266.558.107 1.282.725 1.282m0 0h3.126c1.026 0 1.945.694 2.054 1.715.045.422.068.85.068 1.285a11.95 11.95 0 0 1-2.649 7.521c-.388.482-.987.729-1.605.729H13.48c-.483 0-.964-.078-1.423-.23l-3.114-1.04a4.501 4.501 0 0 0-1.423-.23H5.904m10.598-9.75H14.25M5.904 18.5c.083.205.173.405.27.602.197.4-.078.898-.523.898h-.908c-.889 0-1.713-.518-1.972-1.368a12 12 0 0 1-.521-3.507c0-1.553.295-3.036.831-4.398C3.387 9.953 4.167 9.5 5 9.5h1.053c.472 0 .745.556.5.96a8.958 8.958 0 0 0-1.302 4.665c0 1.194.232 2.333.654 3.375Z"/>
                </svg>

            </button>
            <button onclick="learnNow(-1)">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                     stroke="currentColor" class="w-8 h-8 stroke-slate-500 hover:stroke-red-600">
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="M7.498 15.25H4.372c-1.026 0-1.945-.694-2.054-1.715a12.137 12.137 0 0 1-.068-1.285c0-2.848.992-5.464 2.649-7.521C5.287 4.247 5.886 4 6.504 4h4.016a4.5 4.5 0 0 1 1.423.23l3.114 1.04a4.5 4.5 0 0 0 1.423.23h1.294M7.498 15.25c.618 0 .991.724.725 1.282A7.471 7.471 0 0 0 7.5 19.75 2.25 2.25 0 0 0 9.75 22a.75.75 0 0 0 .75-.75v-.633c0-.573.11-1.14.322-1.672.304-.76.93-1.33 1.653-1.715a9.04 9.04 0 0 0 2.86-2.4c.498-.634 1.226-1.08 2.032-1.08h.384m-10.253 1.5H9.7m8.075-9.75c.01.05.027.1.05.148.593 1.2.925 2.55.925 3.977 0 1.487-.36 2.89-.999 4.125m.023-8.25c-.076-.365.183-.75.575-.75h.908c.889 0 1.713.518 1.972 1.368.339 1.11.521 2.287.521 3.507 0 1.553-.295 3.036-.831 4.398-.306.774-1.086 1.227-1.918 1.227h-1.053c-.472 0-.745-.556-.5-.96a8.95 8.95 0 0 0 .303-.54"/>
                </svg>
            </button>
        </div>


    </div>


</div>

<style>
    #heading {
        font-family: "handsome-pro", sans-serif;
        font-style: normal;
    }
</style>


<script type="module">
    import {initializeApp} from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js'

    // If you enabled Analytics in your project, add the Firebase SDK for Google Analytics
    import {getAnalytics} from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics.js'

    // Add Firebase products that you want to use
    import {getAuth} from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js'
    import {getFirestore} from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js'
</script>

<script>


    <!--    Total sounds -->
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();
    const listener = audioCtx.listener;


    const analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;

    listener.positionX.value = 0;
    listener.positionY.value = 0;
    listener.positionZ.value = 0;

    const panningModel = "HRTF";
    const innerCone = 360;
    const outerCone = 360;
    const outerGain = 0.3;
    const distanceModel = "inverse";

    const maxDistance = 10000;
    const refDistance = 1;
    const rollOff = 10;

    var positionX = -10.5
    var positionY = 0;
    var positionZ = 0;

    const orientationX = 0.0;
    const orientationY = 0.0;
    const orientationZ = -1.0;

    var pannerWaves = new PannerNode(audioCtx, {
        panningModel,
        distanceModel,
        positionX,
        positionY,
        positionZ,
        orientationX,
        orientationY,
        orientationZ,
        refDistance,
        maxDistance,
        rolloffFactor: rollOff,
        coneInnerAngle: innerCone,
        coneOuterAngle: outerCone,
        coneOuterGain: outerGain,
    });

    positionX = 10.5
    var pannerKids = new PannerNode(audioCtx, {
        panningModel,
        distanceModel,
        positionX,
        positionY,
        positionZ,
        orientationX,
        orientationY,
        orientationZ,
        refDistance,
        maxDistance,
        rolloffFactor: rollOff,
        coneInnerAngle: innerCone,
        coneOuterAngle: outerCone,
        coneOuterGain: outerGain,
    });


    positionX = 0
    positionZ = 10.5
    var pannerFirePlace = new PannerNode(audioCtx, {
        panningModel,
        distanceModel,
        positionX,
        positionY,
        positionZ,
        orientationX,
        orientationY,
        orientationZ,
        refDistance,
        maxDistance,
        rolloffFactor: rollOff,
        coneInnerAngle: innerCone,
        coneOuterAngle: outerCone,
        coneOuterGain: outerGain,
    });


    // get the audio element
    const audioElementWaves = document.getElementById("waves");
    const audioElementKids = document.getElementById("kids");
    const audioElementFirePlace = document.getElementById("fireplace");
    const audioElementThunder = document.getElementById("thunder");


    // pass it into the audio context

    const trackWaves = audioCtx.createMediaElementSource(audioElementWaves);
    const trackKids = audioCtx.createMediaElementSource(audioElementKids);
    const trackFirePlace = audioCtx.createMediaElementSource(audioElementFirePlace);
    trackWaves.connect(pannerWaves).connect(analyser);
    trackKids.connect(pannerKids).connect(analyser);
    trackFirePlace.connect(pannerFirePlace).connect(analyser);

    analyser.connect(audioCtx.destination);


    const canvasCtx = document.getElementById("canvasCtx").getContext("2d");
    const HEIGHT = canvasCtx.canvas.height;
    const WIDTH = canvasCtx.canvas.width;

    const bufferLength = analyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);
    canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);

    function draw() {
        drawVisual = requestAnimationFrame(draw);
        analyser.getByteFrequencyData(dataArray);
        canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);
        const barWidth = (WIDTH / bufferLength) * 10;
        let barHeight;
        let x = 0;
        for (let i = 0; i < bufferLength; i++) {
            barHeight = dataArray[i] / 2;

            canvasCtx.fillStyle = `rgb(250 250 250)`;
            canvasCtx.fillRect(x, HEIGHT / 2 - barHeight / 4, barWidth, barHeight / 2);

            x += barWidth + barWidth;
        }
    }


    draw();

    // Select our play button
    const playButton = document.getElementById("playbutton");
    playButton.dataset.playing = "false";
    playButton.addEventListener(
        "click",
        () => {
            console.log("Button pressed")
            // Check if context is in suspended state (autoplay policy)
            if (audioCtx.state === "suspended") {
                audioCtx.resume();
            }

            if (playButton.dataset.playing === "false") {
                console.log("PLaying")
                audioElementWaves.play();
                audioElementKids.play();
                audioElementFirePlace.play();
                playButton.dataset.playing = "true";
            } else if (playButton.dataset.playing === "true") {
                console.log("Pausing")
                audioElementWaves.pause();
                audioElementKids.pause();
                audioElementFirePlace.pause();
                playButton.dataset.playing = "false";
            }
        },
        false,
    );

    // Press playbutton


    class AudioSource {
        constructor(audioElement, radius, playing) {
            this.audioElement = audioElement;
            this.radius = radius;
            this.playing = playing;
        }
    }


    sourceWaves = new AudioSource(audioElementWaves, 1.1, false);
    sourceKids = new AudioSource(audioElementKids, 1.1, false);
    sourceFirePlace = new AudioSource(audioElementFirePlace, 1.1, false);
    wavesDrag = dragElement(document.getElementById("soundWaves"), pannerWaves, sourceWaves);
    kidsDrag = dragElement(document.getElementById("soundKids"), pannerKids, sourceKids);
    fireplaceDrag = dragElement(document.getElementById("soundFirePlace"), pannerFirePlace, sourceFirePlace);

    GAIN = 2;

    function dragElement(elmnt, pann, audoElem) {

        elmnt.onmousedown = dragMouseDown;
        elmnt.ontouchstart = dragMouseDown;

        function dragMouseDown(e) {
            e = e || window.event;
            e.preventDefault();
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;

            document.ontouchmove = elementDrag;
            document.ontouchend = closeDragElement;

        }

        function setXY(x, y) {
            pann.positionX.value = x * GAIN;
            pann.positionZ.value = y * GAIN;
        }

        function elementDrag(e) {
            // print event
            // console.log(e)
            // check if e is touch event
            if (e.touches) {
                // console.log("Toich event");
                e = e.touches[0];
                //
            } else {
                e = e || window.event;
                e.preventDefault();
            }
            // console.log(e.clientX, e.clientY)


            par = document.getElementById('parentBox');
            //print par heigth and width
            rect = par.getBoundingClientRect()
            // console.log(rect.height, rect.width, rect.top, rect.left)

            // set the element's new position:
            elmnt.style.top = e.clientY - rect.top - elmnt.getBoundingClientRect().height / 2 + "px";
            elmnt.style.left = e.clientX - rect.left - elmnt.getBoundingClientRect().width / 2 + "px";

            // console.log( e.clientY - rect.top, e.clientX - rect.left);

            posx = e.clientX - rect.left;
            posy = e.clientY - rect.top;
            posxNorm = 2 * posx / rect.width;
            posyNorm = 2 * posy / rect.height;
            postXCentered = posxNorm - 1.0;
            postYCentered = posyNorm - 1.0;
            console.log(postXCentered, postYCentered);


            // console.log(elmnt.offsetTop, elmnt.offsetLeft, window.innerHeight, window.innerWidth)
            pann.positionX.value = (postXCentered) * GAIN;
            pann.positionZ.value = (postYCentered) * GAIN;

            console.log("Radius = " + Math.sqrt(postYCentered ** 2 + postXCentered ** 2));
            radius = Math.sqrt(postYCentered ** 2 + postXCentered ** 2);
            audoElem.radius = radius;
            if (radius < 1) {
                // print playing
                console.log("Playing")
                audoElem.audioElement.play();
                audoElem.playing = true;
            } else {
                // print paused
                console.log("Paused")
                audoElem.audioElement.pause();
                audoElem.playing = false;
            }

            //     print position
            // console.log(pann.positionX.value, pann.positionZ.value)

        }

        function closeDragElement() {
            // stop moving when mouse button is released:
            document.onmouseup = null;
            document.onmousemove = null;
            //     add touch
            document.ontouchmove = null;
            document.ontouchend = null;
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        const loadEl = document.querySelector('#load');
        firebase.auth().onAuthStateChanged((user) => {
            if (!user) {
                window.location = '/login.html'; // If not signed in, go to login page
            }
            console.log(user);
            document.getElementById('user').textContent = "Logged in as: " + user.displayName;
        });

    });


    function addLike() {
        const db = firebase.firestore();

        console.log('Adding a like');
        db.collection("likes").add({
            user: firebase.auth().currentUser.displayName,
            // Store x,y,z location of panner of each song
            waves: [pannerWaves.positionX.value, pannerWaves.positionY.value, pannerWaves.positionZ.value],
            kids: [pannerKids.positionX.value, pannerKids.positionY.value, pannerKids.positionZ.value],
            fire: [pannerFirePlace.positionX.value, pannerFirePlace.positionY.value, pannerFirePlace.positionZ.value],


            time: firebase.firestore.FieldValue.serverTimestamp()
        })
            .then((docRef) => {
                console.log("Document written with ID: ", docRef.id);
            })
            .catch((error) => {
                console.error("Error adding document: ", error);
            });
        //     Log data to the database

    }


    var global_weights = Array(10).fill(0);

    // Get weights for user from the database if it exists. Otherwise, create a weight vector of size 10 with all zeros and add it to the database and return the weights
    function learnNow(reward) {
        if (reward === 1) {
            addLike();
        } else if (reward === -1) {
            addDislike();
        }
        const db = firebase.firestore();
        const user = firebase.auth().currentUser.displayName;
        db.collection("weights").doc(user).get().then((doc) => {
            // Add userID
            if (doc.exists) {
                console.log("Document data:", doc.data());
                global_weights = doc.data().weights;
                console.log("Global weights", global_weights)
                updateWeightsForLearning(reward);
            } else {
                // doc.data() will be undefined in this case
                console.log("No such document!");
                // Add weights to the database
                db.collection("weights").doc(user).set({
                    weights: global_weights
                })
                    .then(() => {
                        console.log("Document successfully written!");
                    })
                    .catch((error) => {
                        console.error("Error writing document: ", error);
                    });
            }
        }).catch((error) => {
            console.log("Error getting document:", error);
        });
    }


    // Function that takes array of 10 and updates the weights in the database
    function updateWeights(weights) {
        const db = firebase.firestore();
        const user = firebase.auth().currentUser.uid;
        db.collection("weights").doc(user).set({
            weights: weights
        })
            .then(() => {
                console.log("Weights updated!");
            })
            .catch((error) => {
                console.error("Error writing document: ", error);
            });
    }

    function updateWeightsForLearning(reward) {
        var weights = global_weights;
        // Get location of all sounds
        var waves = [pannerWaves.positionX.value, pannerWaves.positionY.value, pannerWaves.positionZ.value];
        var kids = [pannerKids.positionX.value, pannerKids.positionY.value, pannerKids.positionZ.value];
        var fire = [pannerFirePlace.positionX.value, pannerFirePlace.positionY.value, pannerFirePlace.positionZ.value];
        // Get distance of each sound from the listener

        var rewardSum = rewardWaves + rewardKids + rewardFire;
        // normalize
        var rewardWaves = 0;
        var rewardKids = 0;
        var rewardFire = 0;
        if (sourceWaves.playing) {
            rewardWaves = reward * (1 - sourceWaves.radius);
        }
        if (sourceKids.playing) {
            rewardKids = reward * (1 - sourceKids.radius);
        }
        if (sourceFirePlace.playing) {
            rewardFire = reward * (1 - sourceFirePlace.radius);
        }


        // Update the weights based on the reward
        if (rewardWaves !== 0) {
            weights[0] = weights[0] * 0.9 + 0.1 * rewardWaves;
        }
        if (rewardKids !== 0) {
            weights[1] = weights[1] * 0.9 + 0.1 * rewardKids;
        }
        if (rewardFire !== 0) {
            weights[2] = weights[2] * 0.9 + 0.1 * rewardFire;
        }
        // print each reward
        console.log("Reward for waves", rewardWaves);
        console.log("Reward for kids", rewardKids);
        console.log("Reward for fire", rewardFire);
        updateWeights(weights);
    }

    function generateSoundFromGlobalWeights() {
        // Get the weights from the database
        const db = firebase.firestore();
        const user = firebase.auth().currentUser.displayName;
        db.collection("weights").doc(user).get().then((doc) => {
            if (doc.exists) {
                console.log("Document data:", doc.data());
                global_weights = doc.data().weights;
                console.log("Global weights", global_weights)
                // Get the weights and generate the sound
                var waves_radius = global_weights[0];
                var kids_radius = global_weights[1];
                var fire_radius = global_weights[2];
                // sample angle between 135 to 225 degrees
                var waves_angle = Math.random() * (225 - 135) + 135;
                // sample angle between 225 to 315 degrees
                var kids_angle = Math.random() * (315 - 225) + 225;
                // sample angle between 315 to 45 degrees
                var fire_angle = Math.random() * (45 - 315) + 315;
                // Convert to radians
                waves_angle = waves_angle * Math.PI / 180;
                kids_angle = kids_angle * Math.PI / 180;
                fire_angle = fire_angle * Math.PI / 180;
                // Get the x and z coordinates of the sound
                var waves_x = waves_radius * Math.cos(waves_angle);
                var waves_z = waves_radius * Math.sin(waves_angle);
                var kids_x = kids_radius * Math.cos(kids_angle);
                var kids_z = kids_radius * Math.sin(kids_angle);
                var fire_x = fire_radius * Math.cos(fire_angle);
                var fire_z = fire_radius * Math.sin(fire_angle);
                // Set the position of the sounds
                pannerWaves.positionX.value = waves_x * GAIN;
                pannerWaves.positionY.value = 0;
                pannerWaves.positionZ.value = waves_z * GAIN;
                pannerKids.positionX.value = kids_x * GAIN;
                pannerKids.positionY.value = 0;
                pannerKids.positionZ.value = kids_z * GAIN;
                pannerFirePlace.positionX.value = fire_x * GAIN;
                pannerFirePlace.positionY.value = 0;
                pannerFirePlace.positionZ.value = fire_z * GAIN;

                par = document.getElementById('parentBox');
                //print par heigth and width
                rect = par.getBoundingClientRect()

                elmnt = document.getElementById("soundWaves");
                waves_x = waves_x + 1;
                waves_z = waves_z + 1;
                waves_x = waves_x * rect.width / 2;
                waves_z = waves_z * rect.height / 2;
                // waves_x = waves_x + rect.left;
                // waves_z = waves_z + rect.top;

                elmnt.style.top = waves_z - elmnt.getBoundingClientRect().height / 2 + "px";
                elmnt.style.left = waves_x - elmnt.getBoundingClientRect().width / 2 + +"px";

                elmnt = document.getElementById("soundKids");
                kids_x = kids_x + 1;
                kids_z = kids_z + 1;
                kids_x = kids_x * rect.width / 2;
                kids_z = kids_z * rect.height / 2;
                // kids_x = kids_x + rect.left;
                // kids_z = kids_z + rect.top;

                elmnt.style.top = kids_z - elmnt.getBoundingClientRect().height / 2 + "px";
                elmnt.style.left = kids_x - elmnt.getBoundingClientRect().width / 2 + "px";

                elmnt = document.getElementById("soundFirePlace");
                fire_x = fire_x + 1;
                fire_z = fire_z + 1;
                fire_x = fire_x * rect.width / 2;
                fire_z = fire_z * rect.height / 2;
                // fire_x = fire_x + rect.left;
                // fire_z = fire_z + rect.top;

                elmnt.style.top = fire_z - elmnt.getBoundingClientRect().height / 2 + "px";
                elmnt.style.left = fire_x - elmnt.getBoundingClientRect().width / 2 + "px";


            } else {
                // doc.data() will be undefined in this case
                console.log("No such document!");
            }
        }).catch((error) => {
            console.log("Error getting document:", error);
        });
    }

    function addDislike() {
        const db = firebase.firestore();

        console.log('Adding a dislike');
        db.collection("dislikes").add({
            user: firebase.auth().currentUser.displayName,
            // Store x,y,z location of panner of each song
            waves: [pannerWaves.positionX.value, pannerWaves.positionY.value, pannerWaves.positionZ.value],
            kids: [pannerKids.positionX.value, pannerKids.positionY.value, pannerKids.positionZ.value],
            fire: [pannerFirePlace.positionX.value, pannerFirePlace.positionY.value, pannerFirePlace.positionZ.value],
            time: firebase.firestore.FieldValue.serverTimestamp()
        })
            .then((docRef) => {
                console.log("Document written with ID: ", docRef.id);
            })
            .catch((error) => {
                console.error("Error adding document: ", error);
            });
    }

    console.log("Getting weights from db")
    // wait for firebase to load
    // Initialize firebase app
    // firebase.initializeApp();


</script>
</body>
</html>
